#
# Part of: MMUX Bash Pointers
# Contents: core library
# Date: Sep  9, 2024
#
# Abstract
#
#	This library  must be  sourced from an  interactive shell  or from a  script.  It  loads the
#	shared library and enables the implemented builtins.
#
#	The Bash builtin "enable" will search the shared library file in the usual places, including
#	the directories from "LD_LIBRARY_PATH".
#
# Copyright (C) 2024 Marco Maggi <mrc.mgg@gmail.com>
#
# This program is free software: you can redistribute it and/or modify it under the terms of the GNU
# Lesser General Public  License as published by  the Free Software Foundation, either  version 3 of
# the License, or (at your option) any later version.
#
# This program is distributed in the hope that  it will be useful, but WITHOUT ANY WARRANTY; without
# even the  implied warranty of MERCHANTABILITY  or FITNESS FOR  A PARTICULAR PURPOSE.  See  the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the  GNU Lesser General Public License along with this program.
# If not, see <http://www.gnu.org/licenses/>.
#

function mmux-bash-pointers-library-load () {
    # NOTE These  variables are not  read-only; I felt  in the past  that making them  read-only was
    # safer;  but making  them read-only  prevents unsetting  them, which  is needed  to unload  the
    # library.  Given  that if  you can load  this library,  you can make  much damage  even without
    # mutating these  variables: I have  settled on accepting that  they are not  read-only.  (Marco
    # Maggi; Sep 12, 2024)
    #
    declare -g MMUX_BASH_POINTERS_LIBRARY=libmmux-bash-pointers.so
    declare -g MMUX_BASH_POINTERS_CURRENT=@mmux_bash_pointers_VERSION_INTERFACE_CURRENT@
    declare -g MMUX_BASH_POINTERS_REVISION=@mmux_bash_pointers_VERSION_INTERFACE_REVISION@
    declare -g MMUX_BASH_POINTERS_AGE=@mmux_bash_pointers_VERSION_INTERFACE_AGE@
    declare -ga MMUX_BASH_POINTERS_POINTER_TYPES=(pointer schar uchar sint uint slong ulong sllong ullong float double ldouble complex sint8 uint8 sint16 uint16 sint32 uint32 sint64 uint64 ssize usize intmax intptr uintptr ptrdiff mode off pid uid gid)
    declare -ga MMUX_BASH_POINTERS_LIBC_BUILTINS=(malloc realloc calloc free memset memcpy memmove)

    enable -f "$MMUX_BASH_POINTERS_LIBRARY" mmux_bash_pointers_library_init

    # This initialises the library.
    if mmux_bash_pointers_library_init
    then
	declare -i IDX
	declare NAME ALIAS

	for ((IDX=0; IDX < ${#MMUX_BASH_POINTERS_LIBC_BUILTINS[@]}; ++IDX))
	do
	    printf -v NAME  'mmux_bash_pointers_%s' "${MMUX_BASH_POINTERS_LIBC_BUILTINS[$IDX]}"
	    printf -v ALIAS 'libc_%s'               "${MMUX_BASH_POINTERS_LIBC_BUILTINS[$IDX]}"
	    enable -f "$MMUX_BASH_POINTERS_LIBRARY" "$NAME"
	    alias "$ALIAS"="$NAME"
	done

	for ((IDX=0; IDX < ${#MMUX_BASH_POINTERS_POINTER_TYPES[@]}; ++IDX))
	do
	    printf -v NAME  'mmux_bash_pointers_pointer_set_%s' "${MMUX_BASH_POINTERS_POINTER_TYPES[$IDX]}"
	    printf -v ALIAS 'pointer-set-%s'                    "${MMUX_BASH_POINTERS_POINTER_TYPES[$IDX]}"
	    enable -f "$MMUX_BASH_POINTERS_LIBRARY" "$NAME"
	    alias "$ALIAS"="$NAME"

	    printf -v NAME  'mmux_bash_pointers_pointer_ref_%s' "${MMUX_BASH_POINTERS_POINTER_TYPES[$IDX]}"
	    printf -v ALIAS 'pointer-ref-%s'                    "${MMUX_BASH_POINTERS_POINTER_TYPES[$IDX]}"
	    enable -f "$MMUX_BASH_POINTERS_LIBRARY" "$NAME"
	    alias "$ALIAS"="$NAME"
	done
    fi
}

function mmux-bash-pointers-library-unload () {
    declare -i IDX
    declare NAME ALIAS

    enable -d mmux_bash_pointers_library_init

    for ((IDX=0; IDX < ${#MMUX_BASH_POINTERS_LIBC_BUILTINS[@]}; ++IDX))
    do
	printf -v NAME  'mmux_bash_pointers_%s' "${MMUX_BASH_POINTERS_LIBC_BUILTINS[$IDX]}"
	enable -d "$NAME"
    done

    for ((IDX=0; IDX < ${#MMUX_BASH_POINTERS_POINTER_TYPES[@]}; ++IDX))
    do
	printf -v NAME  'mmux_bash_pointers_pointer_set_%s' "${MMUX_BASH_POINTERS_POINTER_TYPES[$IDX]}"
	enable -d "$NAME"

	printf -v NAME  'mmux_bash_pointers_pointer_ref_%s' "${MMUX_BASH_POINTERS_POINTER_TYPES[$IDX]}"
	enable -d "$NAME"
    done

    unset -v MMUX_BASH_POINTERS_LIBRARY
    unset -v MMUX_BASH_POINTERS_CURRENT
    unset -v MMUX_BASH_POINTERS_REVISION
    unset -v MMUX_BASH_POINTERS_AGE
    unset -v MMUX_BASH_POINTERS_POINTER_TYPES
    unset -v MMUX_BASH_POINTERS_LIBC_BUILTINS

    # FIXME  For a  perfect cleanup  we should  also unset  the global  variables defined  by the  C
    # language library  initialisation builtin,  like "libc_SIZEOF_POINTER"  and all  those.  (Marco
    # Maggi; Sep 12, 2024)
}

mmux-bash-pointers-library-load

### end of file
# Local Variables:
# mode: sh
# End:
